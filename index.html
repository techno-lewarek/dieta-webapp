<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kalkulator Delegacji + PDF</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f5f5f5; text-align: center; }
        h1 { margin-top: 0.5em; font-size: 1.6em; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }
        th { background: #2c3e70; color: #fff; }
        input, select {
            width: 100%;
            box-sizing: border-box;
            padding: 4px;
            margin: 0;
        }
        .btn { padding: 10px 20px; margin: 1em 0; font-size: 1em; cursor: pointer; }
        #generatePDF { background: #007bff; color: white; border: none; border-radius: 4px; }
        .logo { max-width: 270px; margin: 0 auto 20px; display: block; }
        .form-group { margin-bottom: 1em; }
        .form-group label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    </style>
</head>
<body>
<datalist id="cityList"></datalist>
<img src="logo.png" alt="Logo" class="logo">
<h1>Kalkulator Diety Krajowej</h1>

<div class="form-group">
    <label for="employeeName">Imię i nazwisko:</label>
    <select id="employeeName">
        <option value="">-- Wybierz --</option>
        <option value="Barczak Dominik">Barczak Dominik</option>
        <option value="Barczak Krzysztof">Barczak Krzysztof</option>
        <option value="Mytnychuk Anton">Mytnychuk Anton</option>
        <option value="Mytnychuk Yurii">Mytnychuk Yurii</option>
        <option value="Witkowski Krzysztof">Witkowski Krzysztof</option>
    </select>
</div>

<div class="form-group">
    <label for="delegationNumber">Numer delegacji służbowej:</label>
    <input type="text" id="delegationNumber" placeholder="np. KW/001/2025">
</div>

<table id="delegationTable">
    <thead>
        <tr>
            <th>Miejsce wyjazdu</th>
            <th>Data</th>
            <th>Godzina</th>
            <th>Miejsce przyjazdu</th>
            <th>Data</th>
            <th>Godzina</th>
            <th>Środek lokomocji</th>
            <th>Koszt przejazdu (zł)</th>
            <th>km (jeśli prywatne)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button class="btn" onclick="addRow()">Dodaj wiersz</button>
<button class="btn" id="generatePDF">Wygeneruj PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    const tbody = document.querySelector("#delegationTable tbody");
    const employeeName = document.getElementById("employeeName");
    const delegationNumber = document.getElementById("delegationNumber");

    employeeName.addEventListener("change", () => {
        const value = employeeName.value;
        if (value) {
            const initials = value.split(" ").map(p => p[0].toUpperCase()).join("");
            delegationNumber.value = initials + "/";
        } else {
            delegationNumber.value = "";
        }
    });

    function addRow() {
        const now = new Date();
        const today = now.toISOString().split("T")[0];
        const defaultTime = "08:00";
        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="text" list="cityList" value="Pakość"></td>
            <td><input type="date" value="${today}"></td>
            <td><input type="time" value="${defaultTime}"></td>
            <td><input type="text" list="cityList"></td>
            <td><input type="date"></td>
            <td><input type="time"></td>
            <td>
                <select onchange="toggleKM(this)">
                    <option value="auto służbowe">Auto służbowe</option>
                    <option value="auto prywatne">Auto prywatne</option>
                    <option value="kolej">Transport kolejowy</option>
                    <option value="lotniczy">Transport lotniczy</option>
                </select>
            </td>
            <td><input type="number" step="0.01" value="0"></td>
            <td><input type="number" step="0.1" disabled></td>
        `;
        tbody.appendChild(row);
    }

    function toggleKM(select) {
        const row = select.closest("tr");
        const kmInput = row.cells[8].firstElementChild;
        const costInput = row.cells[7].firstElementChild;

        if (select.value === "auto prywatne") {
            kmInput.disabled = false;
        } else {
            kmInput.disabled = true;
            kmInput.value = "";
        }
        if (select.value === "auto służbowe") {
            costInput.value = "0";
        }
    }

    addRow();

    // 🔹 pełna lista miast do datalisty
    const cityList = document.getElementById("cityList");
    const polishCities = [
      "Warszawa","Kraków","Łódź","Wrocław","Poznań","Gdańsk","Szczecin","Bydgoszcz",
      "Lublin","Katowice","Białystok","Częstochowa","Radom","Toruń","Sosnowiec",
      "Kielce","Rzeszów","Gliwice","Zabrze","Olsztyn","Bielsko-Biała","Bytom",
      "Zielona Góra","Rybnik","Ruda Śląska","Opole","Tychy","Gorzów Wielkopolski",
      "Dąbrowa Górnicza","Elbląg","Płock","Wałbrzych","Włocławek","Tarnów","Chorzów",
      "Koszalin","Legnica","Grudziądz","Słupsk","Jaworzno","Jastrzębie-Zdrój","Nowy Sącz",
      "Jelenia Góra","Konin","Piotrków Trybunalski","Inowrocław","Lubin","Ostrowiec Świętokrzyski",
      "Siemianowice Śląskie","Gniezno","Stalowa Wola","Suwałki","Głogów","Pabianice","Chełm","Zamość",
      "Leszno","Tomaszów Mazowiecki","Przemyśl","Stargard","Mysłowice","Kutno","Ostrów Wielkopolski","Ełk",
      "Tarnowskie Góry","Piła","Świdnica","Mielec","Tczew","Biała Podlaska","Bełchatów","Zgierz",
      "Świętochłowice","Racibórz","Wejherowo","Zawiercie","Kędzierzyn-Koźle","Starachowice","Skierniewice",
      "Skarżysko-Kamienna","Żory","Ostrołęka","Nowa Sól","Knurów","Lębork","Otwock","Krosno","Ciechanów",
      "Kołobrzeg","Świnoujście","Żyrardów","Tarnobrzeg","Śrem","Bochnia","Sopot","Nowy Dwór Mazowiecki",
      "Jarosław","Wodzisław Śląski","Siedlce","Puławy","Czechowice-Dziedzice","Oława","Żywiec","Piekary Śląskie",
      "Malbork","Kwidzyn","Bartoszyce","Brzeg","Dębica","Łomża","Sanok","Chojnice","Bielawa","Kłodzko","Augustów",
      "Nysa","Luboń","Police","Mińsk Mazowiecki","Brodnica","Wągrowiec","Krotoszyn","Turek","Zduńska Wola",
      "Zambrów","Kościerzyna","Gorlice","Lubań","Sandomierz","Krasnystaw","Hrubieszów","Łuków","Strzelce Opolskie",
      "Działdowo","Wieluń","Wyszków","Środa Wielkopolska","Kępno","Złotów","Szczecinek"
    ];
    polishCities.forEach(city => {
      const option = document.createElement("option");
      option.value = city;
      cityList.appendChild(option);
    });

    function numberToWordsPL(amount) {
        const ones=["","jeden","dwa","trzy","cztery","pięć","sześć","siedem","osiem","dziewięć"];
        const teens=["dziesięć","jedenaście","dwanaście","trzynaście","czternaście","piętnaście","szesnaście","siedemnaście","osiemnaście","dziewiętnaście"];
        const tens=["","","dwadzieścia","trzydzieści","czterdzieści","pięćdziesiąt","sześćdziesiąt","siedemdziesiąt","osiemdziesiąt","dziewięćdziesiąt"];
        const hundreds=["","sto","dwieście","trzysta","czterysta","pięćset","sześćset","siedemset","osiemset","dziewięćset"];
        function toWords(n){
            if(n===0) return "zero";
            const h=Math.floor(n/100);
            const t=Math.floor((n%100)/10);
            const o=n%10;
            let result=[];
            if(h>0) result.push(hundreds[h]);
            if(t===1 && o>0) result.push(teens[o]);
            else { if(t>0) result.push(tens[t]); if(o>0) result.push(ones[o]); }
            return result.join(" ");
        }
        const zl=Math.floor(amount);
        const gr=Math.round((amount-zl)*100);
        const zlWord=toWords(zl)+(zl===1?" złoty":(zl%10>=2&&zl%10<=4&&(zl%100<10||zl%100>=20)?" złote":" złotych"));
        const grWord=gr>0?toWords(gr)+(gr===1?" grosz":(gr%10>=2&&gr%10<=4&&(gr%100<10||gr%100>=20)?" grosze":" groszy")):"";
        return zlWord+(grWord?" "+grWord:"");
    }

    document.getElementById("generatePDF").addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 🔹 pobierz font z katalogu fonts/
        fetch("fonts/NotoSans-Regular.ttf")
          .then(res => res.arrayBuffer())
          .then(font => {
            const fontBase64 = btoa(String.fromCharCode(...new Uint8Array(font)));
            doc.addFileToVFS("NotoSans-Regular.ttf", fontBase64);
            doc.addFont("NotoSans-Regular.ttf", "NotoSans", "normal");
            doc.setFont("NotoSans");

            const delegationVal = delegationNumber.value || "Brak numeru";
            doc.setFontSize(16);
            doc.text(`POLECENIE WYJAZDU SŁUŻBOWEGO\nDelegacja nr: ${delegationVal}`, 105, 15, { align:"center" });

            const rows=Array.from(tbody.querySelectorAll("tr"));
            let dietTotal=0, travelCostTotal=0;

            const dataRows=rows.map(row=>{
                const inputs=row.querySelectorAll("input, select");
                const values=Array.from(inputs).map(input=>input.value||"-");
                const [fromCity,fromDate,fromTime,toCity,toDate,toTime,transport,cost,km]=values;
                const start=new Date(`${fromDate}T${fromTime}`);
                const end=new Date(`${toDate}T${toTime}`);
                const durationH=(end-start)/1000/60/60;
                let diet=0;
                if(durationH>=8 && durationH<12) diet=22.5;
                else if(durationH>=12 && durationH<24) diet=30.0;
                else if(durationH>=24) diet=45.0*Math.floor(durationH/24)+(durationH%24>=12?30:durationH%24>=8?22.5:0);
                dietTotal+=diet;
                travelCostTotal+=parseFloat(cost)||0;
                return [...values,`${diet.toFixed(2)} zł`];
            });

            doc.autoTable({
                head:[["Wyjazd","Data","Godz.","Przyjazd","Data","Godz.","Transport","Koszt (zł)","km","Dieta (zł)"]],
                body:dataRows,
                startY:35,
                theme:'grid',
                styles:{ fontSize:8, cellPadding:1.5, halign:'center' },
                headStyles:{ fillColor:[58,78,122], textColor:255 }
            });

            let finalY=doc.lastAutoTable.finalY+10;
            doc.setFontSize(11);
            doc.text(`Suma kosztów przejazdu: ${travelCostTotal.toFixed(2)} zł`,10,finalY);
            doc.text(`Suma diet: ${dietTotal.toFixed(2)} zł`,10,finalY+7);
            const totalAmount=(travelCostTotal+dietTotal).toFixed(2);
            doc.setFontSize(12);
            doc.text(`RAZEM DO ROZLICZENIA: ${totalAmount} zł`,10,finalY+15);
            doc.setFontSize(10);
            doc.text(`Słownie: ${numberToWordsPL(parseFloat(totalAmount))}`,10,finalY+22);

            doc.text("Zatwierdzono do wypłaty na kwotę: .......................................................",10,finalY+30);
            doc.text("Data: ...........................................    Podpis: ...........................................",10,finalY+38);
            doc.text("Kwituję odbiór kwoty: .................................................................",10,finalY+52);
            doc.text("Data: ...........................................    Podpis: ...........................................",10,finalY+60);

            doc.save("rachunek_delegacji.pdf");
          });
    });
</script>
</body>
</html>