<!DOCTYPE html>
<html lang="pl">
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator Diety Krajowej</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2c3e70; --ui-radius:12px; --ui-border:#d0d7de; --ui-bg:#fff; --ui-text:#111; --ring: rgba(44,62,112,.22);
    }
    body { 
      font-family:'Noto Sans', Arial, sans-serif; 
      margin:2em; 
      background:#f5f5f5; 
      color:#111;
      max-width: 80%; 
      max-height: 80%;      /* <<< NOWE: maksymalnie 80% szerokości */
      margin-left: auto;    /* wycentrowanie */
      margin-right: auto; 
    }
    @media (max-width: 1200px) {
      body {
        max-width: 100%;    /* <<< NOWE: na mniejszych ekranach 100% */
      }
    }

    h1 { margin:.5em 0 1em; font-size:2em; text-align:center }
    .actions { text-align:center; margin:.5em 0 1.25em; }
    .btn { display:inline-block; padding:12px 24px; margin:.3em; font-size:1.1em; cursor:pointer; border:none; border-radius:6px; }
    #generatePDF { background:#007bff; color:#fff; }
    #calcDiet   { background:#16a34a; color:#fff; }
    #addRowBtn  { background:#475569; color:#fff; }
    .logo { max-width:270px; margin:0 auto 20px; display:block }
    .form-group { margin-bottom:1em; max-width:720px; margin-left:auto; margin-right:auto; }
    .form-group label { display:block; margin-bottom:.5em; font-weight:700 }

    /* === SCROLL POZIOMY DLA TABELI === */
    .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-wrapper table { min-width: 1000px; }

    table { width:100%; border-collapse:collapse; margin:1em auto; table-layout:fixed; background:#fff; max-width:1200px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; vertical-align:middle; word-wrap:break-word; overflow-wrap:break-word; font-size:1em; }
    th { background:var(--brand); color:#fff; font-size:1em; }

    .form-group :where(input, select), #delegationTable :where(input, select){
      -webkit-appearance:none; appearance:none; width:100%; box-sizing:border-box; height:38px; padding:0 10px; margin:0;
      border:1px solid var(--ui-border); border-radius:var(--ui-radius); background:var(--ui-bg); color:var(--ui-text);
      font:500 14px/1.3 'Noto Sans', Arial, sans-serif; transition:border-color .15s, box-shadow .15s, background-color .15s;
      box-shadow:inset 0 1px 0 rgba(17,17,17,.03), 0 1px 2px rgba(17,17,17,.03);
    }
    .form-group :where(input, select):hover, #delegationTable :where(input, select):hover{ border-color:#b6bec8; background:#fafafa; }
    .form-group :where(input, select):focus, #delegationTable :where(input, select):focus{ outline:0; border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); background:#fff; }

    #delegationTable input[type=number]::-webkit-outer-spin-button, #delegationTable input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    #delegationTable input[type=number]{ -moz-appearance:textfield; }
    #delegationTable :where(input, select):disabled{ background:#f3f4f6; color:#6b7280; cursor:not-allowed; }

    #msg { max-width:1200px; margin:.5em auto; text-align:center; }
    .msg-error{ background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; padding:.75em 1em; border-radius:8px; display:none; }
    .msg-ok   { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; padding:.75em 1em; border-radius:8px; display:none; }
    .hint { font-size:.95em; text-align:left; max-width:1200px; margin:0 auto; color:#374151}

    /* Mini-select w komórce transportu */
    .transport-cell { display:flex; gap:8px; align-items:center; }
    .transport-cell select { flex:1; }
    .engine-select { display:none; min-width:210px; }

    /* Dedykowane style do PDF (mniejsza czcionka i kompresja, żeby nie obcinało wierszy) */
    @media print {
      table th, table td { font-size:0.55em !important; padding:2px !important; }
      h2, h1 { font-size:0.9em !important; }
      p { font-size:0.65em !important; }
    }

    #pdf-fallback table th, #pdf-fallback table td { font-size:0.55em !important; padding:2px !important; }
    #pdf-fallback h2 { font-size:0.9em !important; }
    #pdf-fallback p { font-size:0.65em !important; }
  </style>
</head>
<body>
  <datalist id="cityList"></datalist>
  <img src="logo.png" alt="Logo" class="logo" />
  <h1>Kalkulator Diety Krajowej</h1>

  <div class="form-group">
    <label for="employeeName">Imię i nazwisko:</label>
    <select id="employeeName">
      <option value="">-- Wybierz --</option>
      <option value="Barczak Dominik">Barczak Dominik</option>
      <option value="Barczak Krzysztof">Barczak Krzysztof</option>
      <option value="Mytnychuk Anton">Mytnychuk Anton</option>
      <option value="Mytnychuk Yurii">Mytnychuk Yurii</option>
      <option value="Witkowski Krzysztof">Witkowski Krzysztof</option>
    </select>
  </div>

  <div class="form-group">
    <label for="delegationNumber">Numer delegacji służbowej:</label>
    <input type="text" id="delegationNumber" placeholder="np. KW/001/2025" />
  </div>

  <!-- DODANE POLE: Jednostka przyjmująca delegowanego pracownika (klient) -->
  <div class="form-group">
    <label for="clientUnit">Jednostka przyjmująca delegowanego pracownika (klient):</label>
    <input type="text" id="clientUnit" placeholder="np. Nazwa firmy / oddział" />
  </div>
  <!-- KONIEC DODANEGO POLA -->

  <p class="hint">Uzupełnij: w pierwszym wierszu <strong>Data + Godz.</strong> WYJAZDU, w ostatnim wierszu <strong>Data + Godz.</strong> PRZYJAZDU. Diety liczone są wyłącznie po tym zakresie.</p>

  <div class="table-wrapper">
    <table id="delegationTable">
      <thead>
        <tr>
          <th>Miejsce wyjazdu</th>
          <th>Data</th>
          <th>Godzina</th>
          <th>Miejsce przyjazdu</th>
          <th>Data</th>
          <th>Godzina</th>
          <th>Środek lokomocji</th>
          <th>km (jeśli prywatne)</th> <!-- ZAMIANA KOLEJNOŚCI -->
          <th>Koszt przejazdu (zł)</th> <!-- ZAMIANA KOLEJNOŚCI -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- NOWE: Pola pod tabelą dla auta prywatnego -->
  <div class="form-group" id="carInfoBlock">
    <label>Auto prywatne – dane do rozliczenia:</label>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <input type="text" id="carMakeModel" placeholder="Marka i model (np. Toyota Corolla)" />
      <input type="text" id="carPlates" placeholder="Nr rejestracyjny (np. WX 12345)" />
    </div>
  </div>
  <!-- KONIEC NOWEGO BLOKU -->

  <div class="actions">
    <button class="btn" id="addRowBtn">Dodaj wiersz</button>
    <button class="btn" id="generatePDF">Wygeneruj PDF</button>
    <button class="btn" id="calcDiet">Tylko wylicz mi dietę</button>
  </div>

  <div id="msg" aria-live="polite">
    <div id="msgError" class="msg-error"></div>
    <div id="msgOk" class="msg-ok"></div>
  </div>

  <div id="pdf-fallback" style="display:none;"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const tbody = document.querySelector("#delegationTable tbody");
      const employeeName = document.getElementById("employeeName");
      const delegationNumber = document.getElementById("delegationNumber");
      const clientUnit = document.getElementById("clientUnit"); // <-- istniejące nowe pole
      const addRowBtn = document.getElementById('addRowBtn');
      const generateBtn = document.getElementById('generatePDF');
      const calcBtn = document.getElementById('calcDiet');
      const msgErr = document.getElementById('msgError');
      const msgOk = document.getElementById('msgOk');

      // NOWE: dane auta do PDF (pod tabelą)
      const carMakeModel = document.getElementById('carMakeModel');
      const carPlates = document.getElementById('carPlates');

      // Stawki kilometrówki
      const KM_RATE = {
        small: 0.89, // <= 900 cm3
        large: 1.15  // > 900 cm3
      };

      function showError(text){ msgOk.style.display='none'; msgErr.textContent=text; msgErr.style.display='block'; }
      function showOk(text){ msgErr.style.display='none'; msgOk.textContent=text; msgOk.style.display='block'; }
      function clearMsgs(){ msgErr.style.display='none'; msgOk.style.display='none'; }

      employeeName.addEventListener("change", () => {
        const value = employeeName.value;
        delegationNumber.value = value ? value.split(" ").map(p => p[0].toUpperCase()).join("") + "/" : "";
      });

      function addRow() {
        const now = new Date();
        const today = now.toISOString().split("T")[0];
        const defaultTime = "08:00";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" list="cityList" value="Pakość" /></td>
          <td><input type="date" value="${today}" /></td>
          <td><input type="time" value="${defaultTime}" /></td>
          <td><input type="text" list="cityList" /></td>
          <td><input type="date" /></td>
          <td><input type="time" /></td>
          <td>
            <div class="transport-cell">
              <select class="transport-select">
                <option value="auto służbowe">Auto służbowe</option>
                <option value="auto prywatne">Auto prywatne</option>
                <option value="kolej">Transport kolejowy</option>
                <option value="lotniczy">Transport lotniczy</option>
              </select>
              <select class="engine-select" title="Pojemność silnika (kilometrówka)">
                <option value="small">≤ 900 cm³ (0,89 zł/km)</option>
                <option value="large">&gt; 900 cm³ (1,15 zł/km)</option>
              </select>
            </div>
          </td>
          <td><input type="number" step="0.1" class="km-input" disabled /></td>               <!-- ZAMIANA KOLEJNOŚCI -->
          <td><input type="number" step="0.01" class="cost-input" value="0" /></td>          <!-- ZAMIANA KOLEJNOŚCI -->
        `;

        const transportSelect = row.querySelector('.transport-select');
        const engineSelect = row.querySelector('.engine-select');
        const kmInput = row.querySelector('.km-input');
        const costInput = row.querySelector('.cost-input');

        function recomputePrivateCost(){
          const km = parseFloat(kmInput.value);
          const rate = engineSelect.value === 'large' ? KM_RATE.large : KM_RATE.small;
          const cost = (isNaN(km) ? 0 : km) * rate;
          costInput.value = (Math.round(cost * 100) / 100).toFixed(2);
        }

        function applyTransportMode(){
          const mode = transportSelect.value;
          if (mode === "auto prywatne") {
            engineSelect.style.display = 'block';
            kmInput.disabled = false;
            costInput.readOnly = true;
            recomputePrivateCost();
          } else {
            engineSelect.style.display = 'none';
            kmInput.disabled = true;
            kmInput.value = "";
            costInput.readOnly = false;

            if (mode === "auto służbowe") {
              costInput.value = "0";
              costInput.readOnly = true; // służbowe – nie rozliczamy kosztu
            }
          }
        }

        transportSelect.addEventListener('change', applyTransportMode);
        engineSelect.addEventListener('change', recomputePrivateCost);
        kmInput.addEventListener('input', recomputePrivateCost);

        // Startowy stan
        applyTransportMode();

        tbody.appendChild(row);
      }

      addRowBtn.addEventListener('click', addRow);
      addRow(); // start z 1 wierszem

      // Datalist
      const cityList = document.getElementById("cityList");
      (["Warszawa","Kraków","Łódź","Wrocław","Poznań","Gdańsk","Szczecin","Bydgoszcz","Lublin","Katowice","Białystok","Częstochowa","Radom","Toruń","Sosnowiec","Kielce","Rzeszów","Gliwice","Zabrze","Olsztyn","Bielsko-Biała","Bytom","Zielona Góra","Rybnik","Ruda Śląska","Opole","Tychy","Gorzów Wielkopolski","Dąbrowa Górnicza","Elbląg","Płock","Wałbrzych","Włocławek","Tarnów","Chorzów","Koszalin","Legnica","Grudziądz","Słupsk","Jaworzno","Jastrzębie-Zdrój","Nowy Sącz","Jelenia Góra","Konin","Piotrków Trybunalski","Inowrocław","Lubin","Ostrowiec Świętokrzyski","Siemianowice Śląskie","Gniezno","Stalowa Wola","Suwałki","Głogów","Pabianice","Chełm","Zamość","Leszno","Tomaszów Mazowiecki","Przemyśl","Stargard","Mysłowice","Kutno","Ostrów Wielkopolski","Ełk","Tarnowskie Góry","Piła","Świdnica","Mielec","Tczew","Biała Podlaska","Bełchatów","Zgierz","Świętochłowice","Racibórz","Wejherowo","Zawiercie","Kędzierzyn-Koźle","Starachowice","Skierniewice","Skarżysko-Kamienna","Żory","Ostrołęka","Nowa Sól","Knurów","Lębork","Otwock","Krosno","Ciechanów","Kołobrzeg","Świnoujście","Żyrardów","Tarnobrzeg","Śrem","Bochnia","Sopot","Nowy Dwór Mazowiecki","Jarosław","Wodzisław Śląski","Siedlce","Puławy","Czechowice-Dziedzice","Oława","Żywiec","Piekary Śląskie","Malbork","Kwidzyn","Bartoszyce","Brzeg","Dębica","Łomża","Sanok","Chojnice","Bielawa","Kłodzko","Augustów","Nysa","Luboń","Police","Mińsk Mazowiecki","Brodnica","Wągrowiec","Krotoszyn","Turek","Zduńska Wola","Zambrów","Kościerzyna","Gorlice","Lubań","Sandomierz","Krasnystaw","Hrubieszów","Łuków","Strzelce Opolskie","Działdowo","Wieluń","Wyszków","Środa Wielkopolska","Kępno","Złotów","Szczecinek"]).forEach(city => {
        const option = document.createElement("option");
        option.value = city;
        cityList.appendChild(option);
      });

      // formatery
      const fmtPLN = (v) => new Intl.NumberFormat('pl-PL', { style:'currency', currency:'PLN' }).format(v);
      const fmtDT  = (d) => d ? new Date(d).toLocaleString('pl-PL') : "-";

      // >>> KLUCZ: dieta liczona TYLKO od 1. wyjazdu do ostatniego przyjazdu
      function computeDelegations() {
        const rows = Array.from(tbody.querySelectorAll("tr"));

        // Uwaga: po zamianie kolumn koszt jest w index 8 (a km w 7)
        const travelCostTotal = rows.reduce((sum, row) => {
          const cost = parseFloat(row.cells[8]?.querySelector('.cost-input')?.value);
          return sum + (isNaN(cost) ? 0 : cost);
        }, 0);

        if (!rows.length) {
          return { mapped:[], travelCostTotal:0, dietTotal:0, totalAmount:0, earliest:null, latest:null, durationH:0, ok:false, reason:"Brak wierszy" };
        }

        const first = rows[0];
        const last  = rows[rows.length - 1];

        const fromDate = first.cells[1]?.firstElementChild?.value;
        const fromTime = first.cells[2]?.firstElementChild?.value;
        const toDate   = last.cells[4]?.firstElementChild?.value;
        const toTime   = last.cells[5]?.firstElementChild?.value;

        let earliest = null, latest = null, durationH = 0, ok = true, reason = "";

        if (fromDate && fromTime) earliest = new Date(`${fromDate}T${fromTime}`);
        if (toDate && toTime)     latest   = new Date(`${toDate}T${toTime}`);

        if (!earliest || !latest) {
          ok = false;
          reason = "Uzupełnij pierwszy wiersz (Data+Godz. wyjazdu) i ostatni wiersz (Data+Godz. przyjazdu).";
        } else if (!(latest > earliest)) {
          ok = false;
          reason = "Godzina przyjazdu w ostatnim wierszu musi być późniejsza niż wyjazdu w pierwszym.";
        } else {
          durationH = (latest - earliest) / 36e5;
        }

        let dietTotal = 0;
        if (ok) {
          if (durationH >= 8 && durationH < 12)      dietTotal = 22.5;
          else if (durationH >= 12 && durationH < 24) dietTotal = 45.0;
          else if (durationH >= 24) {
            dietTotal = 45.0 * Math.floor(durationH / 24)
                      + (durationH % 24 >= 12 ? 45.0 : (durationH % 24 >= 8 ? 22.5 : 0));
          }
        }

        // mapujemy potrzebne wartości do PDF (zachowując nową kolejność kolumn)
        const mapped = rows.map(row => {
          const fromCity = row.cells[0].querySelector('input')?.value || "-";
          const fromDate = row.cells[1].querySelector('input')?.value || "-";
          const fromTime = row.cells[2].querySelector('input')?.value || "-";
          const toCity   = row.cells[3].querySelector('input')?.value || "-";
          const toDate   = row.cells[4].querySelector('input')?.value || "-";
          const toTime   = row.cells[5].querySelector('input')?.value || "-";
          const transportSelect = row.cells[6].querySelector('.transport-select');
          const engineSelect = row.cells[6].querySelector('.engine-select');
          const transport = transportSelect ? transportSelect.value : "-";
          const engine = engineSelect && engineSelect.style.display !== 'none' ? engineSelect.value : null;
          const kmVal = row.cells[7].querySelector('.km-input')?.value || "-";
          const costVal = row.cells[8].querySelector('.cost-input')?.value || "0";

          return {
            fromCity, fromDate, fromTime,
            toCity, toDate, toTime,
            transport, engine, kmVal, costVal
          };
        });

        const totalAmount = travelCostTotal + dietTotal;
        return { mapped, travelCostTotal, dietTotal, totalAmount, earliest, latest, durationH, ok, reason };
      }

      calcBtn.addEventListener("click", () => {
        clearMsgs();
        const { ok, reason, dietTotal, travelCostTotal, earliest, latest, durationH } = computeDelegations();
        if (!ok) { showError(reason); return; }
        const dietStr    = (Math.round(dietTotal * 100) / 100).toFixed(2).replace('.', ',');
        const travelStr  = (Math.round(travelCostTotal * 100) / 100).toFixed(2).replace('.', ',');
        const zakres     = ` (okres: ${fmtDT(earliest)} – ${fmtDT(latest)}, ${durationH.toFixed(1)} h)`;
        showOk(`Za wybrane wyjazdy przysługuje ${dietStr} zł${zakres}, a za dojazdy pozostaje do zwrotu ${travelStr} zł`);
      });

      // --- DETEKCJA MOBILNA I BLOKADA DLA GENEROWANIA PDF NA TELEFONACH ---
      function isMobile() {
        return (window.innerWidth && window.innerWidth <= 767) ||
               /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
      }

      // Listener w trybie capture, by zablokować kliknięcie PRZED Twoim handlerem na mobile
      generateBtn.addEventListener('click', function (e) {
        if (isMobile()) {
          e.preventDefault();
          e.stopImmediatePropagation();
          showError("Generowanie PDF dostępne tylko na komputerze. Na telefonie możesz jedynie wyliczyć dietę (użyj przycisku „Tylko wylicz mi dietę”).");
        }
      }, { capture: true });
      // --- KONIEC MOBILNEJ BLOKADY ---

      // PDF (html2pdf)
      generateBtn.addEventListener("click", async () => {
        clearMsgs();
        if (typeof html2pdf === 'undefined') {
          showError("Nie udało się załadować biblioteki html2pdf z CDN. Odśwież stronę (Ctrl+Shift+R).");
          return;
        }

        const { ok, reason, mapped, travelCostTotal, dietTotal, earliest, latest } = computeDelegations();
        if (!ok) { showError(reason); return; }

        const fallback = document.getElementById("pdf-fallback");
        fallback.innerHTML = "";

        // Wewnętrzny root skalowany do rozmiaru A4 (minus marginesy)
        const root = document.createElement("div");
        root.id = "pdf-content";
        root.style.width = "190mm"; // 210mm - 20mm marginesu (10mm po bokach)

        const h = document.createElement("h2");
        const delegationVal = delegationNumber.value || "Brak numeru";
        const todayStrFB = new Date().toLocaleDateString('pl-PL');
        h.textContent = `POLECENIE WYJAZDU SŁUŻBOWEGO Nr: ${delegationVal}`;
        h.style.fontSize = "1em";
        root.appendChild(h);

        // Informacja o jednostce przyjmującej klienta
        const clientUnitVal = (clientUnit?.value || "").trim() || "-";
        const clientInfo = document.createElement("p");
        clientInfo.style.fontSize = "0.85em";
        clientInfo.style.margin = "0 0 6px 0";
        clientInfo.innerHTML = `<strong>Jednostka przyjmująca delegowanego pracownika (klient):</strong> ${clientUnitVal}`;
        root.appendChild(clientInfo);

        // NOWE: Dane auta prywatnego (jeśli podano cokolwiek)
        const carMM = (carMakeModel?.value || "").trim();
        const carPL = (carPlates?.value || "").trim();
        if (carMM || carPL) {
          const carP = document.createElement("p");
          carP.style.fontSize = "0.85em";
          carP.style.margin = "0 0 6px 0";
          carP.innerHTML = `<strong>Auto prywatne:</strong> ${carMM || "-"}; <strong>Rejestracja:</strong> ${carPL || "-"}`;
          root.appendChild(carP);
        }

        const tbl = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th colspan="7" style="font-size: 0.8em; text-align:left">Imię i nazwisko: ${employeeName.value || "-"}</th>
            <th colspan="3" style="font-size: 0.8em; text-align:left">Data: ${todayStrFB}</th>
          </tr>
          <tr>
            <th colspan="3" style="font-size: 0.8em">Wyjazd</th>
            <th colspan="4" style="font-size: 0.8em">Przyjazd</th>
            <th colspan="3" style="font-size: 0.8em">Koszty przejazdu</th>
          </tr>
          <tr>
            <th style="font-size: 0.65em; white-space: nowrap;">Miejscowość</th>
            <th style="font-size: 0.8em; white-space: nowrap;">Data</th>
            <th style="font-size: 0.8em; white-space: nowrap;">Godz.</th>
            <th style="font-size: 0.65em; white-space: nowrap;">Miejscowość</th>
            <th style="font-size: 0.8em; white-space: nowrap;">Data</th>
            <th style="font-size: 0.8em; white-space: nowrap;">Godz.</th>
            <th style="font-size: 0.8em; white-space: nowrap;">Dieta (zł)</th>
            <th style="font-size: 0.8em; white-space: nowrap;">Transport</th>
            <th style="font-size: 0.8em; white-space: nowrap;">km</th>          <!-- ZAMIANA KOLEJNOŚCI W PDF -->
            <th style="font-size: 0.8em; white-space: nowrap;">Koszt (zł)</th> <!-- ZAMIANA KOLEJNOŚCI W PDF -->
          </tr>`;
        tbl.appendChild(thead);

        const tbodyEl = document.createElement("tbody");
        mapped.forEach(m => {
          const transportTxt = (() => {
            if (m.transport === 'auto prywatne') {
              const tag = m.engine === 'large' ? '>900 cm³' : '≤900 cm³';
              return `auto prywatne (${tag})`;
            }
            return m.transport || "-";
          })();

          const tr = document.createElement("tr");
          const cells = [
            m.fromCity, m.fromDate, m.fromTime,
            m.toCity, m.toDate, m.toTime,
            "—",
            transportTxt,
            (m.kmVal === "" || m.kmVal == null || m.kmVal === "-") ? "-" : String(m.kmVal),
            (parseFloat(m.costVal) || 0).toFixed(2).replace('.', ',')
          ];
          tr.innerHTML = cells.map(c => `<td style="font-size:65%;">${c || "-"}</td>`).join("");
          tbodyEl.appendChild(tr);
        });
        tbl.appendChild(tbodyEl);
        root.appendChild(tbl);

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `
          <p style="font-size: 0.85em; text-align: left;"><strong>Suma diet (globalnie):</strong> ${fmtPLN(dietTotal)}</p>
          <p style="font-size: 0.8em; text-align: left; margin-bottom: 1em; font-style: italic; font-weight: normal;"><strong>Słownie:</strong> ${numberToWordsPL(dietTotal)}</p>

          <p style="font-size: 0.85em; text-align: left;"><strong>Suma kosztów przejazdu:</strong> ${fmtPLN(travelCostTotal)}</p>
          <p style="font-size: 0.8em; text-align: left; margin-bottom: 1em; font-style: italic; font-weight: normal;"><strong>Słownie:</strong> ${numberToWordsPL(travelCostTotal)}</p>

          <p style="font-size: 0.9em; text-align: left;"><strong>RAZEM DO ROZLICZENIA:</strong> ${fmtPLN(travelCostTotal + dietTotal)}</p>
          <p style="font-size: 0.8em; text-align: left; margin-bottom: 3.5em; font-style: italic; font-weight: normal;"><strong>Słownie:</strong> ${numberToWordsPL(travelCostTotal + dietTotal)}</p>

          <p><strong>________________________________________________________________________________________________________________________________________________________________</strong></p>
          <p style="font-size: 0.8em; text-align: left; margin-bottom: 2em;">
            Zatwierdzono do wypłaty na kwotę: ....................................................................................................................
          </p>
          <p style="font-size: 0.8em; text-align: left;; margin-bottom: 3.5em">
            Data: ............................................................&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Podpis: .....................................................................................
          </p>

          <p><strong>________________________________________________________________________________________________________________________________________________________________</strong></p>
          <p style="font-size: 0.8em; text-align: left; margin-bottom: 2em;">
            Kwituję odbiór kwoty: ..............................................................................................................................
          </p>
          <p style="font-size: 0.8em; text-align: left;">
            Data: ............................................................&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Podpis: .....................................................................................
          </p>
        `;
        root.appendChild(summary);

        // Podłącz i pokaż
        fallback.appendChild(root);
        fallback.style.display = "block";

        // --- SKALOWANIE do jednej strony A4 ---
        const pxPerMm = 96 / 25.4;    // CSS px przy 96dpi
        const pageHeightMm = 297;     // A4 (portret)
        const marginsMm = 20;         // 10mm góra/dół jak w opcjach html2pdf
        const availablePx = (pageHeightMm - marginsMm) * pxPerMm;
        const contentHeight = root.scrollHeight; // wysokość treści w px
        const scale = 0.95;
        root.style.transformOrigin = 'top left';
        root.style.transform = `scale(${scale})`;

        try{
          await html2pdf().from(fallback).set({
            margin: 10,
            filename: "DEL_" + (delegationNumber.value || "bez-numeru") + ".pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          }).save();
          clearMsgs();
        } catch(err){
          showError("Błąd generowania PDF: " + (err?.message || err));
        } finally {
          fallback.style.display = "none";
          root.style.transform = '';
        }
      });

      // liczby słownie do PDF — POPRAWIONA WERSJA
      function numberToWordsPL(amount) {
        const ones = ["", "jeden", "dwa", "trzy", "cztery", "pięć", "sześć", "siedem", "osiem", "dziewięć"];
        const teens = ["dziesięć", "jedenaście", "dwanaście", "trzynaście", "czternaście", "piętnaście", "szesnaście", "siedemnaście", "osiemnaście", "dziewiętnaście"];
        const tens = ["", "", "dwadzieścia", "trzydzieści", "czterdzieści", "pięćdziesiąt", "sześćdziesiąt", "siedemdziesiąt", "osiemdziesiąt", "dziewięćdziesiąt"];
        const hundreds = ["", "sto", "dwieście", "trzysta", "czterysta", "pięćset", "sześćset", "siedemset", "osiemset", "dziewięćset"];

        function toWordsUnder1000(n) {
          if (n === 0) return "";
          const h = Math.floor(n / 100);
          const t = Math.floor((n % 100) / 10);
          const o = n % 10;
          const out = [];

          if (h > 0) out.push(hundreds[h]);

          if (t === 1) {
            out.push(o === 0 ? "dziesięć" : teens[o]);
          } else {
            if (t > 0) out.push(tens[t]);
            if (o > 0) out.push(ones[o]);
          }
          return out.join(" ").trim();
        }

        function toWords(n) {
          if (n === 0) return "zero";
          const thousands = Math.floor(n / 1000);
          const rest = n % 1000;
          const out = [];
          if (thousands > 0) {
            if (thousands === 1) {
              out.push("tysiąc");
            } else {
              out.push(toWordsUnder1000(thousands));
              const lastDigit = thousands % 10, lastTwo = thousands % 100;
              out.push(lastDigit >= 2 && lastDigit <= 4 && !(lastTwo >= 12 && lastTwo <= 14) ? "tysiące" : "tysięcy");
            }
          }
          if (rest > 0) out.push(toWordsUnder1000(rest));
          return out.join(" ").trim();
        }

        const amountRounded = Math.round((amount + Number.EPSILON) * 100) / 100;
        const zl = Math.floor(amountRounded);
        const gr = Math.round((amountRounded - zl) * 100);

        const zlWord =
          toWords(zl) +
          (zl === 1 ? " złoty"
            : zl % 10 >= 2 && zl % 10 <= 4 && (zl % 100 < 10 || zl % 100 >= 20) ? " złote"
            : " złotych");

        const grWord = gr > 0
          ? toWords(gr) + (gr === 1 ? " grosz"
            : gr % 10 >= 2 && gr % 10 <= 4 && (gr % 100 < 10 || gr % 100 >= 20) ? " grosze" : " groszy")
          : "";

        return zlWord + (grWord ? " " + grWord : "");
      }
      // liczby słownie do PDF — POPRAWIONA WERSJA
      function numberToWordsPL(amount) {
        // ...
      }

      // --- SKALOWANIE STRONY PRZY MNIEJSZYCH ROZDZIELCZOŚCIACH ---
      function applyScaling() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        if (w < 1920 && h < 1200) {
          document.body.style.transform = "scale(0.8)";
          document.body.style.transformOrigin = "top center";
        } else {
          document.body.style.transform = "";
        }
      }

      // uruchom przy starcie i przy zmianie rozmiaru okna
      applyScaling();
      window.addEventListener("resize", applyScaling);
    });
  </script>
</body>
</html>
