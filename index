<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Kalkulator Delegacji + PDF</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans', Arial, sans-serif; background:#f5f5f5; margin:2em; text-align:center }
    .container { max-width:1000px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    h1 { font-size:1.6em; margin-bottom:1em; }
    .form-group { margin:1em auto; text-align:center; max-width:400px; }
    .form-group label { display:block; margin-bottom:.5em; font-weight:700 }
    .form-group input, .form-group select { width:100%; padding:6px; }
    .actions { display:flex; justify-content:center; gap:15px; margin:1.5em 0; }
    .btn { padding:10px 20px; font-size:1em; cursor:pointer; border:none; border-radius:4px }
    .btn-add { background:#28a745; color:#fff; }
    .btn-pdf { background:#007bff; color:#fff; }
    .table-wrapper { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; margin-bottom:1em; table-layout:fixed; font-size:0.9em }
    th, td { border:1px solid #ccc; padding:4px; text-align:center; word-wrap:break-word; }
    th { background:#2c3e70; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="Logo" class="logo" style="max-width:250px;margin-bottom:20px;" />
    <h1>Kalkulator Diety Krajowej</h1>

    <div class="form-group">
      <label for="employeeName">Imię i nazwisko:</label>
      <select id="employeeName">
        <option value="">-- Wybierz --</option>
        <option value="Barczak Dominik">Barczak Dominik</option>
        <option value="Barczak Krzysztof">Barczak Krzysztof</option>
        <option value="Mytnychuk Anton">Mytnychuk Anton</option>
        <option value="Mytnychuk Yurii">Mytnychuk Yurii</option>
        <option value="Witkowski Krzysztof">Witkowski Krzysztof</option>
      </select>
    </div>

    <div class="form-group">
      <label for="delegationNumber">Numer delegacji służbowej:</label>
      <input type="text" id="delegationNumber" placeholder="np. KW/001/2025" />
    </div>

    <div class="table-wrapper">
      <table id="delegationTable">
        <thead>
          <tr>
            <th>Miejsce wyjazdu</th>
            <th>Data</th>
            <th>Godzina</th>
            <th>Miejsce przyjazdu</th>
            <th>Data</th>
            <th>Godzina</th>
            <th>Środek lokomocji</th>
            <th>Koszt przejazdu (zł)</th>
            <th>km (jeśli prywatne)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="actions">
      <button class="btn btn-add" onclick="addRow()">Dodaj wiersz</button>
      <button class="btn btn-pdf" id="generatePDF">Wygeneruj PDF</button>
    </div>
  </div>

  <!-- biblioteki -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    const tbody = document.querySelector("#delegationTable tbody");
    const employeeName = document.getElementById("employeeName");
    const delegationNumber = document.getElementById("delegationNumber");

    employeeName.addEventListener("change", () => {
      const value = employeeName.value;
      delegationNumber.value = value ? value.split(" ").map(p => p[0].toUpperCase()).join("") + "/" : "";
    });

    function addRow() {
      const today = new Date().toISOString().split("T")[0];
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" /></td>
        <td><input type="date" value="${today}" /></td>
        <td><input type="time" value="08:00" /></td>
        <td><input type="text" /></td>
        <td><input type="date" /></td>
        <td><input type="time" /></td>
        <td>
          <select onchange="toggleKM(this)">
            <option value="auto służbowe">Auto służbowe</option>
            <option value="auto prywatne">Auto prywatne</option>
            <option value="kolej">Transport kolejowy</option>
            <option value="lotniczy">Transport lotniczy</option>
          </select>
        </td>
        <td><input type="number" step="0.01" value="0" /></td>
        <td><input type="number" step="0.1" disabled /></td>
      `;
      tbody.appendChild(row);
    }
    addRow();

    function toggleKM(select) {
      const row = select.closest("tr");
      const kmInput = row.cells[8].firstElementChild;
      const costInput = row.cells[7].firstElementChild;
      if (select.value === "auto prywatne") {
        kmInput.disabled = false;
      } else {
        kmInput.disabled = true;
        kmInput.value = "";
      }
      if (select.value === "auto służbowe") {
        costInput.value = "0";
      }
    }

    const fmtPLN = (v) => new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(v);

    function numberToWordsPL(amount) {
      const ones=["","jeden","dwa","trzy","cztery","pięć","sześć","siedem","osiem","dziewięć"];
      const teens=["dziesięć","jedenaście","dwanaście","trzynaście","czternaście","piętnaście","szesnaście","siedemnaście","osiemnaście","dziewiętnaście"];
      const tens=["","","dwadzieścia","trzydzieści","czterdzieści","pięćdziesiąt","sześćdziesiąt","siedemdziesiąt","osiemdziesiąt","dziewięćdziesiąt"];
      const hundreds=["","sto","dwieście","trzysta","czterysta","pięćset","sześćset","siedemset","osiemset","dziewięćset"];
      function toWords(n){
        if(n===0) return "zero";
        const h=Math.floor(n/100), t=Math.floor((n%100)/10), o=n%10; let r=[];
        if(h>0) r.push(hundreds[h]);
        if(t===1 && o>0) r.push(teens[o]); else { if(t>0) r.push(tens[t]); if(o>0) r.push(ones[o]); }
        return r.join(" ");
      }
      const zl=Math.floor(amount), gr=Math.round((amount-zl)*100);
      const zlWord=toWords(zl)+(zl===1?" złoty":(zl%10>=2&&zl%10<=4&&(zl%100<10||zl%100>=20)?" złote":" złotych"));
      const grWord=gr>0?toWords(gr)+(gr===1?" grosz":(gr%10>=2&&gr%10<=4&&(gr%100<10||gr%100>=20)?" grosze":" groszy")):"";
      return zlWord+(grWord?" "+grWord:"");
    }

    async function loadFont(doc) {
      try {
        const res = await fetch("fonts/NotoSans-Regular.ttf");
        const buf = await res.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        doc.addFileToVFS("NotoSans-Regular.ttf", base64);
        doc.addFont("NotoSans-Regular.ttf", "NotoSans", "normal");
        doc.setFont("NotoSans");
      } catch (e) {
        console.warn("Font nie załadowany", e);
      }
    }

    document.getElementById("generatePDF").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'mm', format:'a4' });
      await loadFont(doc);
      doc.setFont("NotoSans");

      const pageW = doc.internal.pageSize.getWidth();
      const margin = { top: 20, left: 12, right: 12 };

      // data w prawym górnym rogu
      const todayStr = new Date().toLocaleDateString('pl-PL');
      doc.setFontSize(10);
      doc.text("______________________________", pageW - margin.right, margin.top, { align:"right" });
      doc.text(todayStr, pageW - margin.right, margin.top+6, { align:"right" });
      doc.setFont("NotoSans");

      // tytuł
      doc.setFontSize(12);
      doc.text("POLECENIE WYJAZDU SŁUŻBOWEGO", pageW/2, margin.top+20, { align:"center" });
      doc.setFont("NotoSans");

      // tabela
      const rows = [...tbody.querySelectorAll("tr")].map(row=>{
        return [...row.querySelectorAll("input, select")].map(i=>i.value||"-");
      });
      doc.autoTable({
        head:[["Wyjazd","Data","Godz.","Przyjazd","Data","Godz.","Transport","Koszt","km"]],
        body: rows,
        startY: margin.top+30,
        styles:{ font:"NotoSans", fontSize:8, cellPadding:1, lineHeight:1 },
        headStyles:{ fillColor:[44,62,112], textColor:255 },
        bodyStyles:{ lineColor:[0,0,0] }
      });
      doc.setFont("NotoSans");

      // podsumowania
      let y = doc.lastAutoTable.finalY+10;
      doc.setFontSize(11);
      doc.text("Suma kosztów przejazdu: " + fmtPLN(0), margin.left, y);
      y+=6; doc.setFontSize(10); doc.text("Słownie: " + numberToWordsPL(0), margin.left, y);

      y+=10; doc.setFontSize(11);
      doc.text("Suma diet: " + fmtPLN(0), margin.left, y);
      y+=6; doc.setFontSize(10); doc.text("Słownie: " + numberToWordsPL(0), margin.left, y);

      y+=10; doc.setFontSize(12);
      doc.text("RAZEM DO ROZLICZENIA: " + fmtPLN(0), margin.left, y);
      y+=6; doc.setFontSize(10); doc.text("Słownie: " + numberToWordsPL(0), margin.left, y);

      doc.save("delegacja.pdf");
    });
  </script>
</body>
</html>
